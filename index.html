<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Communism Party – Hóriver's Lair (Grid Prototype)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #050104;
      color: #f7e3c8;
      overflow: hidden;
    }

    h1 {
      margin-top: 10px;
      text-align: center;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      font-size: 18px;
      color: #ffdd88;
    }

    #subtitle {
      text-align: center;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-top: 4px;
      color: #ffbb66;
    }

    #game-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 90px);
    }

    canvas {
      border: 2px solid #ffcc66;
      background: #000;
      image-rendering: pixelated;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
    }

    #controls {
      margin-top: 8px;
      font-size: 13px;
      opacity: 0.9;
      color: #ffe6bf;
      text-align: center;
    }

    #interactionPrompt {
      margin-top: 4px;
      font-size: 13px;
      text-align: center;
      color: #ffdd88;
      min-height: 18px;
    }

    /* Overlays */

    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.88);
      z-index: 20;
    }

    .overlay.active {
      display: flex;
    }

    .overlay-card {
      border-radius: 1.4rem;
      border: 2px solid #ffcc66;
      background: radial-gradient(circle at top, #4b0000 0, #050104 60%);
      padding: 1.6rem 2rem 1.8rem;
      max-width: 480px;
      text-align: center;
      color: #ffe6bf;
      box-shadow: 0 26px 70px rgba(0, 0, 0, 0.9);
    }

    .overlay-card img {
      max-width: 260px;
      image-rendering: pixelated;
      border-radius: 0.7rem;
      margin-bottom: 0.9rem;
    }

    .overlay-title {
      font-size: 1.4rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #ffdd88;
      margin-bottom: 0.5rem;
    }

    .overlay-sub {
      font-size: 0.92rem;
      margin-bottom: 1.1rem;
    }

    .btn {
      cursor: pointer;
      border-radius: 999px;
      padding: 0.6rem 1.5rem;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: none;
      margin: 0 0.4rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ffcc66, #ff4848);
      color: #3b0000;
      font-weight: 800;
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.7);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid #ffcc66;
      color: #ffdd88;
    }

    .btn:hover {
      filter: brightness(1.06);
    }

    /* Horiver hears you banner */

    #alertBanner {
      position: fixed;
      left: 50%;
      top: 10%;
      transform: translateX(-50%);
      padding: 0.5rem 1.1rem;
      border-radius: 999px;
      border: 1px solid #ff4444;
      background: rgba(60, 0, 0, 0.93);
      color: #ffdddd;
      font-size: 0.82rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      text-align: center;
      display: none;
      z-index: 25;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.8);
    }

    #welcomeOverlay img {
      max-width: 280px;
    }

    @media (max-width: 720px) {
      #game-wrapper {
        transform: scale(0.9);
      }
      .overlay-card {
        margin: 0 1rem;
        padding-inline: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <h1>HÓRIVER’S LAIR – LEVEL 1</h1>
  <div id="subtitle">
    Mission: find the flashlight, key, vape and bathroom in Hóriver’s cursed castle
  </div>

  <div id="game-wrapper">
    <canvas id="game" width="400" height="400"></canvas>
    <div id="controls">
      Move with <b>W A S D</b>. <b>R</b> = interact (pick up, flush, claim). <b>F</b> = hide in closets. Closets only protect you while hiding. Hóriver kills on contact.
    </div>
    <div id="interactionPrompt"></div>
  </div>

  <!-- Horiver hears you -->
  <div id="alertBanner">HÓRIVER HEARS YOU</div>

  <!-- Welcome / start overlay -->
  <div id="welcomeOverlay" class="overlay active">
    <div class="overlay-card">
      <img src="images/horiver-lair.png" alt="Horiver's Lair" />
      <div class="overlay-title">COMMUNISM PARTY HQ</div>
      <div class="overlay-sub">
        Enter Hóriver's cursed vape castle. Grab the flashlight, steal the vape, flush it, and escape with your token.
      </div>
      <button class="btn btn-primary" id="startBtn">Start Level</button>
    </div>
  </div>

  <!-- Death overlay -->
  <div id="deathOverlay" class="overlay">
    <div class="overlay-card">
      <img src="images/horiver-jumpscare.png" alt="Horiver Jumpscare" />
      <div class="overlay-title" style="color:#ff5555;">WASTED</div>
      <div class="overlay-sub">
        Hóriver caught you in the dark. The vape lives on and the castle reeks forever.
      </div>
      <button class="btn btn-primary" id="retryBtn">Retry Level</button>
    </div>
  </div>

  <!-- Win overlay -->
  <div id="winOverlay" class="overlay">
    <div class="overlay-card">
      <img src="images/bhoriver-token.png" alt="Token" />
      <div class="overlay-title">MISSION COMPLETE</div>
      <div class="overlay-sub">
        The vape is flushed. Hóriver screams and fades into communist vapor. You claim your cursed token.
      </div>
      <button class="btn btn-primary" id="playAgainBtn">Play Again</button>
    </div>
  </div>

  <script>
    // ====== Canvas / map basics ======
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const tileSize = 40;
    const rows = 10;
    const cols = 10;

    // Tiles:
    // 0 = floor, 1 = wall, 2 = closet, 3 = throne, 4 = key,
    // 5 = chest (vape), 6 = bathroom, 7 = flashlight, 8 = start
    const map = [
      [1,1,1,1,1,1,1,1,1,1],
      [1,8,0,0,0,0,0,0,7,1],
      [1,0,1,1,0,1,1,0,5,1],
      [1,0,1,3,0,0,1,0,1,1],
      [1,0,1,1,1,0,1,0,0,1],
      [1,0,4,0,1,0,0,0,0,1],
      [1,1,0,1,1,1,1,1,0,1],
      [1,0,0,0,0,0,0,1,0,1],
      [1,0,2,1,1,2,0,1,6,1],
      [1,1,1,1,1,1,1,1,1,1]
    ];

    let player = { x: 1, y: 1 };
    let horiver = { x: 3, y: 3, active: false, alive: true };
    let startPos = { x: 1, y: 1 };

    // Game state
    let haveFlashlight = false;
    let haveKey = false;
    let haveVape = false;
    let vapeDestroyed = false;
    let gameOver = false;
    let win = false;

    let hidden = false; // true when hiding in closet
    let lastMoveDir = { dx: 0, dy: 1 }; // for flashlight cone

    // ====== Images ======
    const imgPlayer = new Image();
    imgPlayer.src = "images/player.png";

    const imgHoriver = new Image();
    imgHoriver.src = "images/horiver-character.png";

    const imgFlashlight = new Image();
    imgFlashlight.src = "images/pixel-flashlight.png";

    const imgKey = new Image();
    imgKey.src = "images/key pixel.png";

    const imgVape = new Image();
    imgVape.src = "images/vape pixel.png";

    // ====== Sounds ======
    const sounds = {
      bgm: new Audio("sounds/backg-music.mp3"),
      start: new Audio("sounds/start-sound.mp3"),
      menuClick: new Audio("sounds/menu-click.mp3"),
      pickup: new Audio("sounds/item-pickup.mp3"),
      door: new Audio("sounds/door-open.mp3"),
      flush: new Audio("sounds/toilet-flush.mp3"),
      jumpscare: new Audio("sounds/jumpscare.mp3"),
      win: new Audio("sounds/win.mp3"),
      deathScream: new Audio("sounds/horiver-death-scream.mp3")
    };
    sounds.bgm.loop = true;
    sounds.bgm.volume = 0.4;

    function safePlay(a) {
      a.currentTime = 0;
      a.play().catch(() => {});
    }

    // ====== Utilities ======
    function tileAt(x, y) {
      if (x < 0 || y < 0 || x >= cols || y >= rows) return 1;
      return map[y][x];
    }

    function setTile(x, y, value) {
      if (x < 0 || y < 0 || x >= cols || y >= rows) return;
      map[y][x] = value;
    }

    function isWalkable(x, y) {
      const t = tileAt(x, y);
      return t !== 1;
    }

    function isCloset(x, y) {
      return tileAt(x, y) === 2;
    }

    function findTile(value) {
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          if (map[y][x] === value) return { x, y };
        }
      }
      return null;
    }

    // ====== BFS pathfinding for Horiver ======
    function getNextStep(sx, sy, tx, ty) {
      if (sx === tx && sy === ty) return null;
      const q = [];
      const prev = Array.from({ length: rows }, () => Array(cols).fill(null));
      q.push({ x: sx, y: sy });
      prev[sy][sx] = { x: sx, y: sy };

      const dirs = [
        { dx: 1, dy: 0 },
        { dx: -1, dy: 0 },
        { dx: 0, dy: 1 },
        { dx: 0, dy: -1 }
      ];

      while (q.length) {
        const cur = q.shift();
        if (cur.x === tx && cur.y === ty) break;

        for (const d of dirs) {
          const nx = cur.x + d.dx;
          const ny = cur.y + d.dy;
          if (nx < 0 || ny < 0 || nx >= cols || ny >= rows) continue;
          if (prev[ny][nx]) continue;
          if (!isWalkable(nx, ny)) continue;
          prev[ny][nx] = { x: cur.x, y: cur.y };
          q.push({ x: nx, y: ny });
        }
      }

      if (!prev[ty][tx]) return null;

      // backtrack
      let cx = tx;
      let cy = ty;
      while (prev[cy][cx].x !== sx || prev[cy][cx].y !== sy) {
        const p = prev[cy][cx];
        cx = p.x;
        cy = p.y;
      }
      return { dx: cx - sx, dy: cy - sy };
    }

    // ====== Drawing ======
    function drawMap() {
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const t = map[y][x];
          let color;

          if (t === 1) {
            color = "#3b1517"; // walls
          } else if (t === 2) {
            color = "#153438"; // closets
          } else if (t === 3) {
            color = "#553322"; // throne
          } else if (t === 6) {
            color = "#2b3d57"; // bathroom
          } else {
            color = "#120509"; // floor & others
          }

          ctx.fillStyle = color;
          ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);

          // subtle grid lines
          ctx.strokeStyle = "#1a050a";
          ctx.strokeRect(x * tileSize, y * tileSize, tileSize, tileSize);
        }
      }

      // items
      const fTile = findTile(7);
      if (fTile && !haveFlashlight) {
        drawSprite(imgFlashlight, fTile.x, fTile.y);
      }

      const kTile = findTile(4);
      if (kTile && !haveKey) {
        drawSprite(imgKey, kTile.x, kTile.y);
      }

      const chestTile = findTile(5);
      if (chestTile) {
        ctx.fillStyle = "#5a3a14";
        ctx.fillRect(
          chestTile.x * tileSize + 6,
          chestTile.y * tileSize + 10,
          tileSize - 12,
          tileSize - 14
        );
        if (!haveVape && !vapeDestroyed && haveKey) {
          drawSprite(imgVape, chestTile.x, chestTile.y);
        }
      }
    }

    function drawSprite(img, gx, gy) {
      const pad = 4;
      const x = gx * tileSize + pad;
      const y = gy * tileSize + pad;
      const size = tileSize - pad * 2;
      if (img.complete && img.naturalWidth) {
        ctx.drawImage(img, x, y, size, size);
      } else {
        ctx.fillStyle = "#0cf";
        ctx.fillRect(x, y, size, size);
      }
    }

    function drawCharacters() {
      // horiver first so player overlaps
      if (horiver.active && horiver.alive) {
        drawSprite(imgHoriver, horiver.x, horiver.y);
      }

      // player (hidden players are not drawn)
      if (!hidden) {
        drawSprite(imgPlayer, player.x, player.y);
      }
    }

    function drawLighting() {
      const centerX = player.x * tileSize + tileSize / 2;
      const centerY = player.y * tileSize + tileSize / 2;

      // Dark fog everywhere except near player
      const baseInner = haveFlashlight ? 20 : 10;
      const baseOuter = haveFlashlight ? 160 : 100;

      const g = ctx.createRadialGradient(
        centerX, centerY, baseInner,
        centerX, centerY, baseOuter
      );
      g.addColorStop(0, "rgba(0,0,0,0)");
      g.addColorStop(0.6, "rgba(0,0,0,0.4)");
      g.addColorStop(1, "rgba(0,0,0,0.96)");
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Soft warm cone when flashlight picked up
      if (haveFlashlight) {
        const dx = lastMoveDir.dx || 0;
        const dy = lastMoveDir.dy || 1;
        const coneLength = 160;  // about 4 tiles
        const coneWidth = 70;    // fairly slim

        const tipX = centerX + dx * coneLength;
        const tipY = centerY + dy * coneLength;

        const perpX = -dy;
        const perpY = dx;

        const leftX = centerX + perpX * (coneWidth * 0.5);
        const leftY = centerY + perpY * (coneWidth * 0.5);
        const rightX = centerX - perpX * (coneWidth * 0.5);
        const rightY = centerY - perpY * (coneWidth * 0.5);

        ctx.save();
        ctx.globalCompositeOperation = "lighter";
        const coneGrad = ctx.createLinearGradient(centerX, centerY, tipX, tipY);
        coneGrad.addColorStop(0, "rgba(255, 240, 210, 0.45)");
        coneGrad.addColorStop(1, "rgba(255, 240, 210, 0)");
        ctx.fillStyle = coneGrad;
        ctx.beginPath();
        ctx.moveTo(leftX, leftY);
        ctx.lineTo(tipX, tipY);
        ctx.lineTo(rightX, rightY);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
      }
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMap();
      drawCharacters();
      drawLighting();
    }

    // ====== Game logic ======
    function resetGame() {
      const start = findTile(8) || { x: 1, y: 1 };
      startPos = { ...start };
      player = { ...start };
      horiver = { x: 3, y: 3, active: false, alive: true };

      haveFlashlight = false;
      haveKey = false;
      haveVape = false;
      vapeDestroyed = false;
      gameOver = false;
      win = false;
      hidden = false;
      lastMoveDir = { dx: 0, dy: 1 };

      document.getElementById("subtitle").textContent =
        "Mission: find the flashlight, key, vape and bathroom in Hóriver’s cursed castle";

      hideAlert();
      updateInteractionPrompt();
      render();
    }

    function showAlert() {
      const el = document.getElementById("alertBanner");
      el.style.display = "block";
      setTimeout(() => {
        el.style.display = "none";
      }, 2000);
    }

    function hideAlert() {
      document.getElementById("alertBanner").style.display = "none";
    }

    function triggerHoriver() {
      if (!horiver.active && horiver.alive) {
        horiver.active = true;
        showAlert();
        safePlay(sounds.jumpscare);
      }
    }

    function killPlayer() {
      if (gameOver || win) return;
      gameOver = true;
      safePlay(sounds.jumpscare);
      document.getElementById("deathOverlay").classList.add("active");
    }

    function finishLevel() {
      if (win) return;
      win = true;
      safePlay(sounds.win);
      document.getElementById("winOverlay").classList.add("active");
    }

    function moveHoriver() {
      if (!horiver.active || !horiver.alive) return;

      const step = getNextStep(horiver.x, horiver.y, player.x, player.y);
      if (step) {
        horiver.x += step.dx;
        horiver.y += step.dy;
      }

      if (horiver.x === player.x && horiver.y === player.y && !hidden) {
        killPlayer();
      }
    }

    // ====== Interaction system (R + F) ======
    const interactionEl = document.getElementById("interactionPrompt");

    function findNearbySpecial(radius = 1) {
      const specials = [7, 4, 5, 6, 3];
      const candidates = [];

      for (let dy = -radius; dy <= radius; dy++) {
        for (let dx = -radius; dx <= radius; dx++) {
          const tx = player.x + dx;
          const ty = player.y + dy;
          const t = tileAt(tx, ty);
          if (specials.includes(t)) {
            const dist = Math.abs(dx) + Math.abs(dy);
            candidates.push({ x: tx, y: ty, t, dist });
          }
        }
      }

      // prioritise by tile type order then distance
      const order = (t) => [7, 4, 5, 6, 3].indexOf(t);
      candidates.sort((a, b) => {
        const o = order(a.t) - order(b.t);
        if (o !== 0) return o;
        return a.dist - b.dist;
      });

      return candidates[0] || null;
    }

    function updateInteractionPrompt() {
      let msg = "";

      const target = findNearbySpecial(1);
      if (target) {
        if (target.t === 7 && !haveFlashlight) {
          msg = "Press R to pick up flashlight";
        }
        if (target.t === 4 && !haveKey) {
          msg = "Press R to pick up key";
        }
        if (target.t === 5 && haveKey && !haveVape && !vapeDestroyed) {
          msg = "Press R to steal Hóriver's vape";
        }
        if (target.t === 6 && haveVape && !vapeDestroyed) {
          msg = "Press R to flush the vape";
        }
        if (target.t === 3 && vapeDestroyed) {
          msg = "Press R to claim your token";
        }
      }

      if (isCloset(player.x, player.y)) {
        const closetMsg = hidden
          ? "Press F to leave closet"
          : "Press F to hide in closet";
        msg = msg ? msg + " | " + closetMsg : closetMsg;
      }

      interactionEl.textContent = msg;
    }

    function tryInteract() {
      if (gameOver || win) return;

      const target = findNearbySpecial(1);
      if (!target) return;

      const { x, y, t } = target;

      if (t === 7 && !haveFlashlight) {
        haveFlashlight = true;
        setTile(x, y, 0);
        safePlay(sounds.pickup);
        document.getElementById("subtitle").textContent =
          "Mission: find the key to Hóriver's chest";
      } else if (t === 4 && !haveKey) {
        haveKey = true;
        setTile(x, y, 0);
        safePlay(sounds.pickup);
        document.getElementById("subtitle").textContent =
          "Mission: locate the chest containing the vape";
        triggerHoriver();
      } else if (t === 5 && haveKey && !haveVape && !vapeDestroyed) {
        haveVape = true;
        safePlay(sounds.door);
        safePlay(sounds.pickup);
        document.getElementById("subtitle").textContent =
          "Mission: find the bathroom and flush the vape";
      } else if (t === 6 && haveVape && !vapeDestroyed) {
        vapeDestroyed = true;
        haveVape = false;
        safePlay(sounds.flush);
        safePlay(sounds.deathScream);
        horiver.alive = false;
        horiver.active = false;
        document.getElementById("subtitle").textContent =
          "Mission: return to the throne to claim your token";
      } else if (t === 3 && vapeDestroyed) {
        finishLevel();
      }

      updateInteractionPrompt();
      render();
    }

    function toggleHide() {
      if (!isCloset(player.x, player.y)) return;
      hidden = !hidden;

      if (hidden) {
        // when you hide, Horiver "loses" you a bit (stops moving this turn)
        interactionEl.textContent = "Hidden in closet. Press F to leave.";
      }

      updateInteractionPrompt();
      render();
    }

    // ====== Input ======
    function handleKey(e) {
      if (gameOver || win) return;

      const key = e.key.toLowerCase();

      if (key === "r") {
        tryInteract();
        return;
      }

      if (key === "f") {
        toggleHide();
        return;
      }

      if (!["w", "a", "s", "d"].includes(key)) return;

      let nx = player.x;
      let ny = player.y;

      if (key === "w") { ny--; lastMoveDir = { dx: 0, dy: -1 }; }
      if (key === "s") { ny++; lastMoveDir = { dx: 0, dy: 1 }; }
      if (key === "a") { nx--; lastMoveDir = { dx: -1, dy: 0 }; }
      if (key === "d") { nx++; lastMoveDir = { dx: 1, dy: 0 }; }

      if (isWalkable(nx, ny)) {
        player.x = nx;
        player.y = ny;
        hidden = false; // moving pops you out if you were hidden
        moveHoriver();
        updateInteractionPrompt();
        render();
      }
    }

    window.addEventListener("keydown", handleKey);

    // ====== Overlay controls ======
    const welcomeOverlay = document.getElementById("welcomeOverlay");
    const deathOverlay = document.getElementById("deathOverlay");
    const winOverlay = document.getElementById("winOverlay");

    document.getElementById("startBtn").addEventListener("click", () => {
      safePlay(sounds.menuClick);
      welcomeOverlay.classList.remove("active");
      resetGame();
      safePlay(sounds.start);
      safePlay(sounds.bgm);
    });

    document.getElementById("retryBtn").addEventListener("click", () => {
      safePlay(sounds.menuClick);
      deathOverlay.classList.remove("active");
      resetGame();
    });

    document.getElementById("playAgainBtn").addEventListener("click", () => {
      safePlay(sounds.menuClick);
      winOverlay.classList.remove("active");
      resetGame();
    });

    // initial render (with overlay up)
    updateInteractionPrompt();
    render();
  </script>
</body>
</html>
