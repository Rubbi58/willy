<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hubios Communism Party – Hóriver's Lair (Prototype)</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #050105;
      color: #fddf62;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow: hidden;
    }

    #game-wrapper {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 20px;
      color: #fddf62;
    }

    h1 {
      letter-spacing: 0.2em;
      font-size: 20px;
      text-transform: uppercase;
      text-align: center;
      margin-bottom: 4px;
    }

    #subtitle {
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 14px;
      text-align: center;
    }

    #game-frame {
      border: 3px solid #fddf62;
      width: 960px;
      height: 640px;
      position: relative;
      background: #020003;
      overflow: hidden;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
      background: #050107;
    }

    #footer-text {
      margin-top: 8px;
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      text-align: center;
    }

    .hidden { display: none; }

    /* MENU / INTRO */

    #menu-overlay,
    #title-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(5,1,7,0.9), #050105 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      flex-direction: column;
      gap: 16px;
    }

    #menu-text { font-size: 18px; max-width: 720px; line-height: 1.5; }

    #menu-hint {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 10px;
    }

    #ready-text {
      font-size: 24px;
      font-weight: 600;
    }

    #horiver-title-screen {
      position: absolute;
      inset: 0;
      background: #050105;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      text-align: center;
    }

    #horiver-title-screen img {
      max-width: 420px;
      max-height: 260px;
      object-fit: contain;
      border-radius: 12px;
      border: 2px solid #fddf62;
      background: #000;
    }

    #horiver-main-title {
      font-size: 28px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
    }

    #horiver-subtitle {
      font-size: 16px;
      opacity: 0.9;
    }

    .btn {
      border: 2px solid #fddf62;
      padding: 10px 28px;
      border-radius: 999px;
      font-size: 15px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      background: transparent;
      color: #fddf62;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 12px rgba(253,223,98,0.35);
      background: rgba(253,223,98,0.08);
    }
    .btn:active { transform: translateY(0); box-shadow: none; }

    /* HUD */

    #hud {
      position: absolute;
      top: 10px;
      left: 12px;
      font-size: 12px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      text-shadow: 0 0 4px #000;
      pointer-events: none;
    }

    #status-message {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      padding: 6px 12px;
      background: rgba(5,1,7,0.85);
      border-radius: 999px;
      border: 1px solid rgba(253,223,98,0.4);
      box-shadow: 0 0 12px rgba(0,0,0,0.8);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    #status-message.visible { opacity: 1; }

    #game-over-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      text-align: center;
      padding: 20px;
      background-position: center;
      background-repeat: no-repeat;
      background-size: contain;
      background-color: rgba(5,1,7,0.97);
    }
    #game-over-overlay.hidden { display: none; }

    #game-over-title {
      font-size: 26px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      text-shadow: 0 0 6px #000;
    }

    #game-over-sub {
      font-size: 15px;
      max-width: 620px;
      line-height: 1.5;
      text-shadow: 0 0 4px #000;
    }

    @media (max-width: 980px) {
      #game-frame {
        width: 100vw;
        height: calc(100vw * 2/3);
        max-height: 640px;
      }
    }
  </style>
</head>
<body>
<div id="game-wrapper">
  <h1>HÓRIVER'S LAIR – LEVEL 1</h1>
  <div id="subtitle">
    MISSION: FIND THE FLASHLIGHT, KEY, VAPE AND BATHROOM IN HÓRIVER'S ENDLESS CASTLE
  </div>

  <div id="game-frame">
    <!-- Intro -->
    <div id="menu-overlay">
      <div id="menu-text"></div>
      <div id="menu-hint">Click anywhere to continue</div>
    </div>

    <div id="title-overlay" class="hidden">
      <div id="ready-text"></div>
      <div id="menu-hint">Click if you dare...</div>
    </div>

    <div id="horiver-title-screen" class="hidden">
      <img id="horiver-lair-img" src="images/horiver-lair.png" alt="Hóriver's Lair" />
      <div id="horiver-main-title">HORIVER'S LAIR</div>
      <div id="horiver-subtitle">Enter</div>
      <button id="enter-btn" class="btn">Enter</button>
    </div>

    <!-- Game canvas -->
    <canvas id="gameCanvas" width="960" height="640" class="hidden"></canvas>

    <!-- HUD -->
    <div id="hud"></div>
    <div id="status-message"></div>

    <!-- Game over / win -->
    <div id="game-over-overlay" class="hidden">
      <div id="game-over-title"></div>
      <div id="game-over-sub"></div>
      <button id="restart-btn" class="btn">Restart from Lair Entrance</button>
    </div>
  </div>

  <div id="footer-text">
    Move with <strong>W A S D</strong>. Closets = safe. Hóriver kills on contact. Fog is thick – use the flashlight. (Press F to toggle fog while testing)
  </div>
</div>

<!-- Background music -->
<audio id="bgMusic" src="sounds/backg-music.mp3" loop></audio>

<script>
"use strict";

/*************** IMAGES & SOUNDS ***************/
const imgPlayer = new Image();
imgPlayer.src = "images/player.png";

const imgHoriver = new Image();
imgHoriver.src = "images/horiver-character.png";

const imgFlashlight = new Image();
imgFlashlight.src = "images/pixel-flashlight.png";

const imgKey = new Image();
imgKey.src = "images/key pixel.png";

const imgVape = new Image();
imgVape.src = "images/vape pixel.png";

const imgJumpscare = new Image();
imgJumpscare.src = "images/horiver-jumpscare.png";

const imgLair = new Image();
imgLair.src = "images/horiver-lair.png";

const imgFurniture = new Image();
imgFurniture.src = "images/furniture.png";

const sMenuClick = new Audio("sounds/menu-click.mp3");
const sStart = new Audio("sounds/start-sound.mp3");
const sItemPickup = new Audio("sounds/item-pickup.mp3");
const sDoorOpen = new Audio("sounds/door-open.mp3");
const sDeathScream = new Audio("sounds/horiver-death-scream.mp3");
const sJumpscare = new Audio("sounds/jumpscare.mp3");
const sToiletFlush = new Audio("sounds/toilet-flush.mp3");
const sWin = new Audio("sounds/win.mp3");

const bgMusic = document.getElementById("bgMusic");

/*************** INTRO / MENUS ***************/
const introLines = [
  "Welcome to Hubios communism party game.",
  "Your mission is to save Communism Iceland,",
  "but first, you need to defeat some foes...",
  "now you'll enter... Horivers lair!!!"
];
const readyLine = "Are you ready?";

const menuOverlay = document.getElementById("menu-overlay");
const menuTextEl = document.getElementById("menu-text");
const titleOverlay = document.getElementById("title-overlay");
const readyTextEl = document.getElementById("ready-text");
const horiverTitleScreen = document.getElementById("horiver-title-screen");
const enterBtn = document.getElementById("enter-btn");
const canvas = document.getElementById("gameCanvas");
const hud = document.getElementById("hud");
const statusMessage = document.getElementById("status-message");
const gameOverOverlay = document.getElementById("game-over-overlay");
const gameOverTitle = document.getElementById("game-over-title");
const gameOverSub = document.getElementById("game-over-sub");
const restartBtn = document.getElementById("restart-btn");

let introIndex = 0;
let typing = false;
let menuStage = 0; // 0=intro,1=ready,2=lair screen,3=game

function typeText(el, text, cb, speed = 32) {
  el.textContent = "";
  let i = 0;
  typing = true;
  const interval = setInterval(() => {
    el.textContent += text[i];
    i++;
    if (i >= text.length) {
      clearInterval(interval);
      typing = false;
      if (cb) cb();
    }
  }, speed);
}

function showNextIntro() {
  if (introIndex < introLines.length) {
    typeText(menuTextEl, introLines[introIndex], null);
    introIndex++;
  } else {
    menuStage = 1;
    menuOverlay.classList.add("hidden");
    titleOverlay.classList.remove("hidden");
    typeText(readyTextEl, readyLine, null, 45);
  }
}

menuOverlay.addEventListener("click", () => {
  if (typing) return;
  try { sMenuClick.currentTime = 0; sMenuClick.play(); } catch(e) {}
  if (menuStage === 0) showNextIntro();
});

titleOverlay.addEventListener("click", () => {
  if (typing) return;
  try { sMenuClick.currentTime = 0; sMenuClick.play(); } catch(e) {}
  if (menuStage === 1) {
    titleOverlay.classList.add("hidden");
    horiverTitleScreen.classList.remove("hidden");
    menuStage = 2;
  }
});

function startGameFromMenu() {
  if (menuStage !== 2) return;
  menuStage = 3;

  horiverTitleScreen.classList.add("hidden");
  canvas.classList.remove("hidden");

  try { sStart.currentTime = 0; sStart.play(); } catch(e) {}
  try { bgMusic.volume = 0.7; bgMusic.play(); } catch(e) {}

  startGame();
}

enterBtn.addEventListener("click", (e) => {
  e.preventDefault();
  startGameFromMenu();
});

/*************** GAME CONSTANTS ***************/
const ctx = canvas.getContext("2d");

const TILE_SIZE = 32;
const MAP_W = 30;
const MAP_H = 30;

const TILE_FLOOR = 0;
const TILE_WALL = 1;
const TILE_CLOSET = 2;
const TILE_LOCKED_DOOR = 3;
const TILE_FLASHLIGHT = 4;
const TILE_KEY = 5;
const TILE_VAPE = 6;
const TILE_BATHROOM = 7;
const TILE_FURN1 = 8;
const TILE_FURN2 = 9;
const TILE_FURN3 = 10;

let map = [];
let player = { x: 0, y: 0, speed: 140 }; // pixels
let horiver = { x: 0, y: 0, speed: 110, active: false };

let hasFlashlight = false;
let hasKey = false;
let hasVape = false;
let alive = true;
let won = false;

let keysPressed = {};
let debugNoFog = false;
let lastTime = 0;

/*************** LEVEL LAYOUT (30x30) ***************/
/*
 Legend:
 # = wall
 . = floor
 C = closet (safe)
 D = locked door
 F = flashlight
 K = key
 V = vape
 B = bathroom (exit)
 S = player spawn
 H = Horiver spawn
 1,2,3 = different furniture pieces
*/
const levelLayout = [
"##############################",
"#S.....C.....####.....C.....#",
"#......#.....#..1.....#.....#",
"#..F...#.....#........#..K..#",
"#......#.....#######..#.....#",
"#......#..............#.....#",
"#..C...####..####..####..C..#",
"#.........................1.#",
"#####..######..######..#####.",
"#..........................#.",
"#..2.......................#.",
"#..........#########.......#.",
"#..........#.....C.#.......#.",
"#....V.....#.......#.......#.",
"#..........#.......#.......#.",
"#..........#########.......#.",
"#..........................#.",
"#..C.......................#.",
"#..........................#.",
"############..##############.",
"#...........D..............#.",
"#...........#..............#.",
"#...........#..............#.",
"#...........#..............#.",
"#.....1.....#......C.......#.",
"#...........#..............#.",
"#.....C.....#...........B..#.",
"#...........#..............#.",
"#...........H..............#.",
"##############################"
];

/*************** MAP PARSING ***************/
function parseMap() {
  map = new Array(MAP_H).fill(null).map(
    () => new Array(MAP_W).fill(TILE_FLOOR)
  );
  let spawnFound = false;
  let horiverFound = false;

  for (let y = 0; y < MAP_H; y++) {
    const row = levelLayout[y] || "";
    for (let x = 0; x < MAP_W; x++) {
      const ch = row[x] || "#";
      let tile = TILE_FLOOR;

      switch (ch) {
        case "#": tile = TILE_WALL; break;
        case ".": tile = TILE_FLOOR; break;
        case "C": tile = TILE_CLOSET; break;
        case "D": tile = TILE_LOCKED_DOOR; break;
        case "F": tile = TILE_FLASHLIGHT; break;
        case "K": tile = TILE_KEY; break;
        case "V": tile = TILE_VAPE; break;
        case "B": tile = TILE_BATHROOM; break;
        case "1": tile = TILE_FURN1; break;
        case "2": tile = TILE_FURN2; break;
        case "3": tile = TILE_FURN3; break;
        case "S":
          tile = TILE_FLOOR;
          if (!spawnFound) {
            player.x = (x + 0.5) * TILE_SIZE;
            player.y = (y + 0.5) * TILE_SIZE;
            spawnFound = true;
          }
          break;
        case "H":
          tile = TILE_FLOOR;
          if (!horiverFound) {
            horiver.x = (x + 0.5) * TILE_SIZE;
            horiver.y = (y + 0.5) * TILE_SIZE;
            horiverFound = true;
          }
          break;
        default:
          tile = TILE_FLOOR;
      }
      map[y][x] = tile;
    }
  }

  if (!spawnFound) {
    player.x = 2.5 * TILE_SIZE;
    player.y = 2.5 * TILE_SIZE;
  }
}

/*************** STATE RESET ***************/
function resetState() {
  hasFlashlight = false;
  hasKey = false;
  hasVape = false;
  alive = true;
  won = false;
  horiver.active = false;
  gameOverOverlay.classList.add("hidden");
}

/*************** STATUS MESSAGES ***************/
function showStatus(text, duration = 2000) {
  statusMessage.textContent = text;
  statusMessage.classList.add("visible");
  setTimeout(() => statusMessage.classList.remove("visible"), duration);
}

/*************** GAME START ***************/
function startGame() {
  parseMap();
  resetState();
  lastTime = performance.now();
  showStatus("Find the flashlight, key, vape – then escape to the bathroom!");
  requestAnimationFrame(gameLoop);
}

/*************** INPUT ***************/
function handleKeyDown(e) {
  if (["KeyW","KeyA","KeyS","KeyD","Enter","KeyF"].includes(e.code)) {
    e.preventDefault();
  }

  if (menuStage === 2 && e.code === "Enter") {
    startGameFromMenu();
    return;
  }

  if (e.code === "KeyF") {
    debugNoFog = !debugNoFog;
    return;
  }

  keysPressed[e.code] = true;
}

function handleKeyUp(e) {
  keysPressed[e.code] = false;
}

window.addEventListener("keydown", handleKeyDown);
window.addEventListener("keyup", handleKeyUp);

/*************** TILE HELPERS ***************/
function tileAtPixel(px, py) {
  const tx = Math.floor(px / TILE_SIZE);
  const ty = Math.floor(py / TILE_SIZE);
  if (tx < 0 || tx >= MAP_W || ty < 0 || ty >= MAP_H) return TILE_WALL;
  return map[ty][tx];
}

function setTileAtPixel(px, py, tile) {
  const tx = Math.floor(px / TILE_SIZE);
  const ty = Math.floor(py / TILE_SIZE);
  if (tx < 0 || tx >= MAP_W || ty < 0 || ty >= MAP_H) return;
  map[ty][tx] = tile;
}

function isSolidTile(tile) {
  return tile === TILE_WALL ||
         tile === TILE_LOCKED_DOOR ||
         tile === TILE_FURN1 ||
         tile === TILE_FURN2 ||
         tile === TILE_FURN3;
}

function isSolidAtPixel(px, py) {
  return isSolidTile(tileAtPixel(px, py));
}

/*************** UPDATE LOGIC ***************/
function update(dt) {
  if (!alive || won) return;
  if (dt > 0.1) dt = 0.1;

  // Player movement
  let ix = 0, iy = 0;
  if (keysPressed["KeyW"]) iy -= 1;
  if (keysPressed["KeyS"]) iy += 1;
  if (keysPressed["KeyA"]) ix -= 1;
  if (keysPressed["KeyD"]) ix += 1;

  const len = Math.hypot(ix, iy) || 1;
  ix /= len; iy /= len;

  const moveX = ix * player.speed * dt;
  const moveY = iy * player.speed * dt;

  let newX = player.x + moveX;
  if (!isSolidAtPixel(newX, player.y)) player.x = newX;

  let newY = player.y + moveY;
  if (!isSolidAtPixel(player.x, newY)) player.y = newY;

  const centerTile = tileAtPixel(player.x, player.y);

  // Items
  if (centerTile === TILE_FLASHLIGHT) {
    hasFlashlight = true;
    setTileAtPixel(player.x, player.y, TILE_FLOOR);
    try { sItemPickup.currentTime = 0; sItemPickup.play(); } catch(e) {}
    showStatus("You picked up the FLASHLIGHT. The fog trembles.");
  }

  if (centerTile === TILE_KEY) {
    hasKey = true;
    setTileAtPixel(player.x, player.y, TILE_FLOOR);
    try { sItemPickup.currentTime = 0; sItemPickup.play(); } catch(e) {}
    showStatus("You picked up a KEY. Some doors might open now.");
  }

  if (centerTile === TILE_VAPE) {
    hasVape = true;
    setTileAtPixel(player.x, player.y, TILE_FLOOR);
    try { sItemPickup.currentTime = 0; sItemPickup.play(); } catch(e) {}
    showStatus("You found the sacred VAPE. Truly powerful.");
    horiver.active = true;
  }

  // Door
  if (centerTile === TILE_LOCKED_DOOR && hasKey) {
    setTileAtPixel(player.x, player.y, TILE_FLOOR);
    try { sDoorOpen.currentTime = 0; sDoorOpen.play(); } catch(e) {}
    showStatus("The key fits. The door opens with a cursed creak.");
  }

  // Bathroom exit
  if (centerTile === TILE_BATHROOM) {
    if (hasFlashlight && hasKey && hasVape) {
      won = true;
      handleWin();
    } else {
      showStatus("You need the flashlight, key AND vape before you can escape!", 2500);
    }
  }

  // Activate Horiver if close
  const distToHoriver = Math.hypot(player.x - horiver.x, player.y - horiver.y);
  if (!horiver.active && distToHoriver < 200) {
    horiver.active = true;
    showStatus("You hear footsteps. Hóriver knows you're here.");
  }

  // Horiver AI
  if (horiver.active) {
    const dx = player.x - horiver.x;
    const dy = player.y - horiver.y;
    const dist = Math.hypot(dx, dy) || 1;
    const vx = (dx / dist) * horiver.speed * dt;
    const vy = (dy / dist) * horiver.speed * dt;

    let hxNew = horiver.x + vx;
    if (!isSolidAtPixel(hxNew, horiver.y)) horiver.x = hxNew;

    let hyNew = horiver.y + vy;
    if (!isSolidAtPixel(horiver.x, hyNew)) horiver.y = hyNew;

    const tileUnderPlayer = centerTile;
    const safeInCloset = tileUnderPlayer === TILE_CLOSET;

    if (!safeInCloset && Math.hypot(player.x - horiver.x, player.y - horiver.y) < 20) {
      handleDeath();
    }
  }
}

/*************** DEATH / WIN ***************/
function handleDeath() {
  alive = false;
  gameOverTitle.textContent = "YOU DIED";
  gameOverSub.textContent =
    "Hóriver caught you skulking through his lair. Maybe try hiding in closets, grabbing the flashlight, and not stealing his vape so loudly.";
  gameOverOverlay.style.backgroundImage = "url('images/horiver-jumpscare.png')";
  gameOverOverlay.classList.remove("hidden");
  try { sJumpscare.currentTime = 0; sJumpscare.play(); } catch(e) {}
  try { sDeathScream.currentTime = 0; sDeathScream.play(); } catch(e) {}
}

function handleWin() {
  gameOverTitle.textContent = "YOU ESCAPED";
  gameOverSub.textContent =
    "You grabbed the flashlight, the key, and the vape, then found the legendary bathroom of Communism Iceland. Hóriver screams in the distance as you slam the door.";
  gameOverOverlay.style.backgroundImage = "url('images/horiver-lair.png')";
  gameOverOverlay.classList.remove("hidden");
  try { sToiletFlush.currentTime = 0; sToiletFlush.play(); } catch(e) {}
  try { sWin.currentTime = 0; sWin.play(); } catch(e) {}
}

restartBtn.addEventListener("click", () => {
  try { sMenuClick.currentTime = 0; sMenuClick.play(); } catch(e) {}
  startGame();
});

/*************** DRAWING ***************/
const FURN_TILE_SIZE = 16; // furniture.png tile size

function drawFurniture(index, px, py) {
  if (!imgFurniture.complete || !imgFurniture.naturalWidth) {
    // fallback simple block
    ctx.fillStyle = "#4c3b2a";
    ctx.fillRect(px + 4, py + 4, TILE_SIZE - 8, TILE_SIZE - 8);
    return;
  }
  const cols = Math.max(1, Math.floor(imgFurniture.naturalWidth / FURN_TILE_SIZE));
  const sx = (index % cols) * FURN_TILE_SIZE;
  const sy = Math.floor(index / cols) * FURN_TILE_SIZE;
  ctx.drawImage(
    imgFurniture,
    sx, sy,
    FURN_TILE_SIZE, FURN_TILE_SIZE,
    px, py,
    TILE_SIZE, TILE_SIZE
  );
}

// We'll just pick three indices from the sheet for the 3 furniture types
const FURN1_INDEX = 0;   // e.g. table
const FURN2_INDEX = 10;  // e.g. cabinet
const FURN3_INDEX = 20;  // e.g. bed/sofa

function drawTile(tile, x, y, camY) {
  const px = x * TILE_SIZE;
  const py = y * TILE_SIZE - camY;

  if (py + TILE_SIZE < 0 || py > canvas.height) return;

  const drawFloorBase = () => {
    ctx.fillStyle = "#18141c";
    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
    ctx.fillStyle = "#211a29";
    ctx.fillRect(px, py + TILE_SIZE - 4, TILE_SIZE, 4);
  };

  switch (tile) {
    case TILE_FLOOR:
      drawFloorBase();
      break;
    case TILE_WALL:
      ctx.fillStyle = "#3b2a20";
      ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
      ctx.strokeStyle = "#8a6848";
      ctx.lineWidth = 2;
      ctx.strokeRect(px + 1, py + 1, TILE_SIZE - 2, TILE_SIZE - 2);
      break;
    case TILE_CLOSET:
      drawFloorBase();
      ctx.fillStyle = "#2b1a0b";
      ctx.fillRect(px + 3, py + 2, TILE_SIZE - 6, TILE_SIZE - 4);
      ctx.fillStyle = "#fddf62";
      ctx.fillRect(px + TILE_SIZE / 2 - 1, py + TILE_SIZE / 2 - 2, 2, 6);
      break;
    case TILE_LOCKED_DOOR:
      drawFloorBase();
      ctx.fillStyle = "#4a2b14";
      ctx.fillRect(px + 2, py + 2, TILE_SIZE - 4, TILE_SIZE - 4);
      ctx.fillStyle = "#fddf62";
      ctx.fillRect(px + TILE_SIZE / 2 - 1, py + TILE_SIZE / 2 - 2, 2, 4);
      break;
    case TILE_FLASHLIGHT:
      drawFloorBase();
      if (imgFlashlight.complete && imgFlashlight.naturalWidth > 0) {
        ctx.drawImage(imgFlashlight, px, py, TILE_SIZE, TILE_SIZE);
      } else {
        ctx.fillStyle = "#ffe88a";
        ctx.fillRect(px + 10, py + 8, 12, 16);
      }
      break;
    case TILE_KEY:
      drawFloorBase();
      if (imgKey.complete && imgKey.naturalWidth > 0) {
        ctx.drawImage(imgKey, px, py, TILE_SIZE, TILE_SIZE);
      } else {
        ctx.fillStyle = "#ffd95f";
        ctx.fillRect(px + 8, py + 12, 16, 8);
      }
      break;
    case TILE_VAPE:
      drawFloorBase();
      if (imgVape.complete && imgVape.naturalWidth > 0) {
        ctx.drawImage(imgVape, px, py, TILE_SIZE, TILE_SIZE);
      } else {
        ctx.fillStyle = "#9be7ff";
        ctx.fillRect(px + 12, py + 6, 8, 18);
      }
      break;
    case TILE_BATHROOM:
      drawFloorBase();
      ctx.fillStyle = "#1a2433";
      ctx.fillRect(px + 2, py + 2, TILE_SIZE - 4, TILE_SIZE - 4);
      ctx.fillStyle = "#fddf62";
      ctx.fillRect(px + TILE_SIZE / 2 - 1, py + TILE_SIZE / 2 - 2, 2, 4);
      ctx.fillStyle = "#ffffff";
      ctx.font = "10px sans-serif";
      ctx.fillText("WC", px + 6, py + 13);
      break;
    case TILE_FURN1:
      drawFloorBase();
      drawFurniture(FURN1_INDEX, px, py);
      break;
    case TILE_FURN2:
      drawFloorBase();
      drawFurniture(FURN2_INDEX, px, py);
      break;
    case TILE_FURN3:
      drawFloorBase();
      drawFurniture(FURN3_INDEX, px, py);
      break;
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Camera: horizontally fixed, vertically follows player
  const maxCamY = MAP_H * TILE_SIZE - canvas.height;
  let camY = player.y - canvas.height / 2;
  if (camY < 0) camY = 0;
  if (camY > maxCamY) camY = maxCamY < 0 ? 0 : maxCamY;

  // Map
  for (let y = 0; y < MAP_H; y++) {
    for (let x = 0; x < MAP_W; x++) {
      drawTile(map[y][x], x, y, camY);
    }
  }

  // Player
  const playerScreenY = player.y - camY;
  if (imgPlayer.complete && imgPlayer.naturalWidth > 0) {
    ctx.drawImage(
      imgPlayer,
      player.x - TILE_SIZE / 2,
      playerScreenY - TILE_SIZE / 2,
      TILE_SIZE,
      TILE_SIZE
    );
  } else {
    ctx.fillStyle = "#fddf62";
    ctx.beginPath();
    ctx.arc(player.x, playerScreenY, TILE_SIZE * 0.35, 0, Math.PI * 2);
    ctx.fill();
  }

  // Horiver
  const horiverScreenY = horiver.y - camY;
  if (imgHoriver.complete && imgHoriver.naturalWidth > 0) {
    const s = TILE_SIZE * 1.5;
    ctx.drawImage(
      imgHoriver,
      horiver.x - s / 2,
      horiverScreenY - s / 2,
      s,
      s
    );
  } else {
    ctx.fillStyle = "#b90035";
    ctx.beginPath();
    ctx.arc(horiver.x, horiverScreenY, TILE_SIZE * 0.45, 0, Math.PI * 2);
    ctx.fill();
  }

  // Fog / flashlight
  if (!debugNoFog) {
    const radius = hasFlashlight ? 320 : 240;

    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,0.75)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const g = ctx.createRadialGradient(
      player.x, playerScreenY, radius * 0.15,
      player.x, playerScreenY, radius
    );
    g.addColorStop(0, "rgba(0,0,0,0)");
    g.addColorStop(0.5, "rgba(0,0,0,0.35)");
    g.addColorStop(1, "rgba(0,0,0,0.95)");

    ctx.globalCompositeOperation = "destination-out";
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(player.x, playerScreenY, radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }

  hud.innerHTML =
    `FLASHLIGHT: <strong>${hasFlashlight ? "YES" : "NO"}</strong> &nbsp;|&nbsp; ` +
    `KEY: <strong>${hasKey ? "YES" : "NO"}</strong> &nbsp;|&nbsp; ` +
    `VAPE: <strong>${hasVape ? "YES" : "NO"}</strong>` +
    (debugNoFog ? " &nbsp;|&nbsp; FOG: OFF (debug)" : "");
}

/*************** GAME LOOP ***************/
function gameLoop(timestamp) {
  const dt = (timestamp - lastTime) / 1000;
  lastTime = timestamp;

  update(dt);
  draw();

  if (alive && !won) {
    requestAnimationFrame(gameLoop);
  }
}

/*************** INITIALIZE INTRO ***************/
showNextIntro();
</script>
</body>
</html>
